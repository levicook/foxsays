#!/bin/bash

# base project configuration
# --------------------------------------------------------------------

# APP_NAME and APP_ROOT enviroment variables
# - all other project automation relies depends on this value being set here.
export APP_NAME=foxsays
export APP_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"


# prereqs - warn people if stuff isn't installed
# --------------------------------------------------------------------
which -s git  || echo 'error: `git` not found, is it installed?'
which -s go   || echo 'error: `go` not found, is it installed?'
which -s node || echo 'error: `node` not found, is it installed?'


# utility functions
# --------------------------------------------------------------------

function ensureDir {
	test -d $1 || mkdir -p $1
}

function ensureIngored {
	# conditionally update .gitignore - don't duplcate the pattern
	# if it's already w/in our .gitignore; make sure it's there tho.

	test -f $APP_ROOT/.gitignore || touch $APP_ROOT/.gitignore

	rel_path=$(echo -n $1 | sed "s|^$APP_ROOT/||")

	grep -q $rel_path $APP_ROOT/.gitignore
	if [ $? -eq 1 ]; then
		echo $rel_path >> $APP_ROOT/.gitignore
	fi
}

function safePrefixPATH {
	# conditionally update the PATH environment variable - don't
	# update PATH if it already contains the path being passed in.
	if [[ ! ":$PATH:" == *":$1:"* ]]; then
		export PATH=$1:$PATH;
	fi
}

function goget {
	go get $1
	ensureIngored $GOPATH/src/$1
}


# extended project environment configuration (rarely change)
# --------------------------------------------------------------------
export APP_TMP=$APP_ROOT/tmp
export GOPATH=$APP_ROOT/server

safePrefixPATH $GOPATH/bin


# ensure core project structure and dependencies exist
# --------------------------------------------------------------------

ensureDir     $APP_TMP
ensureIngored $APP_TMP

ensureDir $GOPATH
ensureDir $GOPATH/bin
ensureDir $GOPATH/pkg
ensureDir $GOPATH/src/$APP_NAME

ensureIngored $GOPATH/bin
ensureIngored $GOPATH/pkg

if [ "$1" != "fast" ]
then
	goget github.com/gorilla/mux
	goget github.com/gorilla/sessions
	goget github.com/levicook/glitch
	goget github.com/spf13/cobra
	goget github.com/stretchr/testify
	goget labix.org/v2/mgo
fi
